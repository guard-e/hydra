<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydra - Вход и регистрация</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
        }
        .login-container {
            background: white;
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }
        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            color: #00a884;
            margin-bottom: 2rem;
        }
        .tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #f0f2f5;
        }
        .tab {
            flex: 1;
            padding: 12px;
            cursor: pointer;
            font-weight: 500;
            color: #667781;
            transition: all 0.3s;
        }
        .tab.active {
            color: #00a884;
            border-bottom: 2px solid #00a884;
        }
        .form-group {
            margin-bottom: 1.2rem;
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #41525d;
            font-weight: 500;
        }
        input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e6e6e6;
            border-radius: 10px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus {
            outline: none;
            border-color: #00a884;
        }
        button {
            width: 100%;
            padding: 14px;
            background-color: #00a884;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 0.5rem;
        }
        button:hover {
            background-color: #008f6f;
        }
        button.secondary {
            background-color: #f0f2f5;
            color: #41525d;
        }
        button.secondary:hover {
            background-color: #e6e6e6;
        }
        .error {
            color: #d32f2f;
            margin-top: 1rem;
            font-size: 14px;
            display: none;
            background: #ffebee;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ffcdd2;
        }
        .success {
            color: #2e7d32;
            margin-top: 1rem;
            font-size: 14px;
            display: none;
            background: #e8f5e8;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #c8e6c9;
        }
        .code-input {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }
        .code-input input {
            flex: 1;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            padding: 12px;
        }
        .timer {
            color: #667781;
            font-size: 14px;
            margin-top: 0.5rem;
        }
        .footer {
            margin-top: 2rem;
            font-size: 14px;
            color: #667781;
        }
        .form-section {
            display: none;
        }
        .form-section.active {
            display: block;
        }
        .method-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }
        .method-btn {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #e6e6e6;
            background: white;
            color: #41525d;
            font-weight: 600;
            cursor: pointer;
        }
        .method-btn.active {
            border-color: #00a884;
            color: #00a884;
        }
        .method-input {
            display: none;
        }
        .method-input.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo">Hydra</div>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('login')">Вход</div>
            <div class="tab" onclick="showTab('register')">Регистрация</div>
        </div>

        <!-- Форма входа -->
        <div id="loginForm" class="form-section active">
            <div class="form-group">
                <label>Email или телефон</label>
                <input type="text" id="loginContact" placeholder="Ваш email или телефон">
            </div>
            <div class="form-group">
                <label>Пароль</label>
                <input type="password" id="loginPassword" placeholder="Ваш пароль">
            </div>
            <button onclick="login()">Войти</button>
            <div class="footer">
                Нет аккаунта? <a href="#" onclick="showTab('register'); return false;">Зарегистрируйтесь</a>
            </div>
        </div>

        <!-- Форма регистрации по телефону -->
        <div id="registerForm" class="form-section">
            <!-- Шаг 1: Ввод телефона -->
            <div id="phoneStep">
                <div class="method-toggle">
                    <button class="method-btn active" id="methodPhone" onclick="setMethod('phone')" type="button">Телефон</button>
                    <button class="method-btn" id="methodEmail" onclick="setMethod('email')" type="button">Почта</button>
                </div>
                <div class="form-group">
                    <label id="contactLabel">Номер телефона</label>
                    <input type="tel" id="registerPhone" class="method-input active" placeholder="+7 (999) 123-45-67" pattern="[+][0-9]{1,3} [0-9]{3} [0-9]{3}-[0-9]{2}-[0-9]{2}">
                    <input type="email" id="registerEmail" class="method-input" placeholder="name@example.com">
                </div>
                <button onclick="sendVerificationCode()">Отправить код подтверждения</button>
            </div>

            <!-- Шаг 2: Ввод кода подтверждения -->
            <div id="codeStep" style="display: none;">
                <div class="form-group">
                    <label>Код подтверждения</label>
                    <div class="code-input">
                        <input type="text" id="code1" maxlength="1" oninput="moveToNext(1)">
                        <input type="text" id="code2" maxlength="1" oninput="moveToNext(2)">
                        <input type="text" id="code3" maxlength="1" oninput="moveToNext(3)">
                        <input type="text" id="code4" maxlength="1" oninput="moveToNext(4)">
                        <input type="text" id="code5" maxlength="1" oninput="moveToNext(5)">
                        <input type="text" id="code6" maxlength="1" oninput="moveToNext(6)">
                    </div>
                    <div class="timer" id="timer">02:00</div>
                </div>
                <button onclick="verifyCode()">Подтвердить код</button>
                <button class="secondary" onclick="resendCode()">Отправить код повторно</button>
            </div>

            <!-- Шаг 3: Ввод данных пользователя -->
            <div id="userInfoStep" style="display: none;">
                <div class="form-group">
                    <label>Ваше имя</label>
                    <input type="text" id="userName" placeholder="Как вас зовут?">
                </div>
                <div class="form-group">
                    <label>Пароль</label>
                    <input type="password" id="userPassword" placeholder="Придумайте пароль">
                </div>
                <div class="form-group">
                    <label>Подтверждение пароля</label>
                    <input type="password" id="userPasswordConfirm" placeholder="Повторите пароль">
                </div>
                <button onclick="completeRegistration()">Завершить регистрацию</button>
            </div>
        </div>

        <div id="errorMsg" class="error"></div>
        <div id="successMsg" class="success"></div>
    </div>

    <script>
        let currentTab = 'login';
        let currentContact = '';
        let currentMethod = 'phone';
        let timerInterval = null;
        let timeLeft = 120; // 2 минуты

        function showTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.form-section').forEach(section => section.classList.remove('active'));
            
            document.querySelector(`.tab:nth-child(${tabName === 'login' ? 1 : 2})`).classList.add('active');
            document.getElementById(tabName + 'Form').classList.add('active');
            
            // Сбрасываем состояние регистрации при переключении вкладок
            if (tabName === 'register') {
                resetRegistration();
            }
        }

        function resetRegistration() {
            document.getElementById('phoneStep').style.display = 'block';
            document.getElementById('codeStep').style.display = 'none';
            document.getElementById('userInfoStep').style.display = 'none';
            document.getElementById('registerPhone').value = '';
            document.getElementById('registerEmail').value = '';
            setMethod('phone');
            
            // Очищаем поля кода
            for (let i = 1; i <= 6; i++) {
                document.getElementById('code' + i).value = '';
            }
            
            // Останавливаем таймер
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            hideMessages();
        }

        function setMethod(method) {
            currentMethod = method;
            document.getElementById('methodPhone').classList.toggle('active', method === 'phone');
            document.getElementById('methodEmail').classList.toggle('active', method === 'email');
            document.getElementById('registerPhone').classList.toggle('active', method === 'phone');
            document.getElementById('registerEmail').classList.toggle('active', method === 'email');
            document.getElementById('contactLabel').textContent = method === 'phone' ? 'Номер телефона' : 'Email';
        }

        function hideMessages() {
            document.getElementById('errorMsg').style.display = 'none';
            document.getElementById('successMsg').style.display = 'none';
        }

        function showError(message) {
            const errorMsg = document.getElementById('errorMsg');
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
            document.getElementById('successMsg').style.display = 'none';
        }

        function showSuccess(message) {
            const successMsg = document.getElementById('successMsg');
            successMsg.textContent = message;
            successMsg.style.display = 'block';
            document.getElementById('errorMsg').style.display = 'none';
        }

        async function login() {
            const contactInfo = document.getElementById('loginContact').value;
            const password = document.getElementById('loginPassword').value;
            
            hideMessages();

            if (!contactInfo || !password) {
                showError('Пожалуйста, заполните все поля');
                return;
            }

            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contact_info: contactInfo, password })
                });

                const data = await res.json();

                if (data.success) {
                    localStorage.setItem('currentUser', JSON.stringify(data.user));
                    window.location.href = '/';
                } else {
                    showError(data.error || 'Ошибка входа');
                }
            } catch (e) {
                showError('Ошибка соединения');
            }
        }

        async function sendVerificationCode() {
            const phone = document.getElementById('registerPhone').value;
            const email = document.getElementById('registerEmail').value;
            
            hideMessages();

            if (currentMethod === 'phone' && !phone) {
                showError('Пожалуйста, введите номер телефона');
                return;
            }

            if (currentMethod === 'email' && !email) {
                showError('Пожалуйста, введите email');
                return;
            }

            if (currentMethod === 'phone') {
                if (!phone.match(/^\+?[0-9\s\-\(\)]{10,}$/)) {
                    showError('Пожалуйста, введите корректный номер телефона');
                    return;
                }
            } else {
                if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                    showError('Пожалуйста, введите корректный email');
                    return;
                }
            }

            try {
                const endpoint = currentMethod === 'phone' ? '/api/sms/send' : '/api/email/send';
                const payload = currentMethod === 'phone' ? { phone } : { email };
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (data.success) {
                    currentContact = currentMethod === 'phone' ? phone : email;
                    document.getElementById('phoneStep').style.display = 'none';
                    document.getElementById('codeStep').style.display = 'block';
                    
                    // Запускаем таймер
                    startTimer();
                    
                    showSuccess(currentMethod === 'phone' ? 'Код подтверждения отправлен на ваш телефон' : 'Код подтверждения отправлен на вашу почту');
                    
                    // Фокусируем первое поле ввода кода
                    document.getElementById('code1').focus();
                } else {
                    showError(data.error || 'Ошибка отправки кода');
                }
            } catch (e) {
                showError('Ошибка соединения');
            }
        }

        function startTimer() {
            timeLeft = 120;
            updateTimerDisplay();
            
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function moveToNext(current) {
            const currentInput = document.getElementById('code' + current);
            const nextInput = document.getElementById('code' + (current + 1));
            
            if (currentInput.value && nextInput) {
                nextInput.focus();
            }
            
            // Если заполнен последний символ, автоматически проверяем код
            if (current === 6 && currentInput.value) {
                verifyCode();
            }
        }

        function getVerificationCode() {
            let code = '';
            for (let i = 1; i <= 6; i++) {
                code += document.getElementById('code' + i).value;
            }
            return code;
        }

        async function verifyCode() {
            const code = getVerificationCode();
            
            hideMessages();

            if (code.length !== 6) {
                showError('Пожалуйста, введите полный код из 6 цифр');
                return;
            }

            try {
                const endpoint = currentMethod === 'phone' ? '/api/sms/verify' : '/api/email/verify';
                const payload = currentMethod === 'phone' ? { phone: currentContact, code } : { email: currentContact, code };
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (data.success) {
                    document.getElementById('codeStep').style.display = 'none';
                    document.getElementById('userInfoStep').style.display = 'block';
                    
                    // Останавливаем таймер
                    if (timerInterval) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                    }
                    
                    showSuccess(currentMethod === 'phone' ? 'Номер телефона подтвержден! Теперь заполните ваши данные' : 'Почта подтверждена! Теперь заполните ваши данные');
                } else {
                    showError(data.error || 'Неверный код подтверждения');
                }
            } catch (e) {
                showError('Ошибка соединения');
            }
        }

        async function completeRegistration() {
            const name = document.getElementById('userName').value;
            const password = document.getElementById('userPassword').value;
            const passwordConfirm = document.getElementById('userPasswordConfirm').value;
            
            hideMessages();

            if (!name || !password || !passwordConfirm) {
                showError('Пожалуйста, заполните все поля');
                return;
            }

            if (password !== passwordConfirm) {
                showError('Пароли не совпадают');
                return;
            }

            if (password.length < 6) {
                showError('Пароль должен содержать минимум 6 символов');
                return;
            }

            try {
                const endpoint = currentMethod === 'phone' ? '/api/auth/phone' : '/api/auth/email';
                const payload = currentMethod === 'phone' 
                    ? { phone: currentContact, name, password }
                    : { email: currentContact, name, password };
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (data.success) {
                    localStorage.setItem('currentUser', JSON.stringify(data.user));
                    showSuccess('Регистрация завершена успешно!');
                    
                    // Перенаправляем на главную страницу через 2 секунды
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                } else {
                    showError(data.error || 'Ошибка регистрации');
                }
            } catch (e) {
                showError('Ошибка соединения');
            }
        }

        async function resendCode() {
            hideMessages();
            
            try {
                const endpoint = currentMethod === 'phone' ? '/api/sms/send' : '/api/email/send';
                const payload = currentMethod === 'phone' ? { phone: currentContact } : { email: currentContact };
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (data.success) {
                    // Перезапускаем таймер
                    startTimer();
                    showSuccess('Код отправлен повторно');
                } else {
                    showError(data.error || 'Ошибка отправки кода');
                }
            } catch (e) {
                showError('Ошибка соединения');
            }
        }

        // Проверяем, если пользователь уже авторизован
        if (localStorage.getItem('currentUser')) {
            window.location.href = '/';
        }

        // Добавляем обработчики для клавиш в полях ввода
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (currentTab === 'login') {
                    login();
                } else if (document.getElementById('phoneStep').style.display !== 'none') {
                    sendVerificationCode();
                } else if (document.getElementById('codeStep').style.display !== 'none') {
                    verifyCode();
                } else if (document.getElementById('userInfoStep').style.display !== 'none') {
                    completeRegistration();
                }
            }
        });
    </script>
</body>
</html>
